generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Search {
  id        String   @id @default(cuid())
  name      String
  url       String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  listings  LbcProductListing[]

  @@map("searches")
}

model LbcProductListing {
  id          String    @id @default(cuid())
  lbcId       String    @unique
  searchId    String
  url         String
  title       String
  priceCents  Int
  city        String?
  region      String?
  publishedAt DateTime?
  status      String    @default("new")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  search      Search           @relation(fields: [searchId], references: [id], onDelete: Cascade)
  images      ListingImage[]
  aiAnalysis  AiAnalysis?
  notifications Notification[]
  labels      ListingLabel[]

  @@index([searchId])
  @@index([lbcId])
  @@index([status])
  @@index([publishedAt])
  @@map("lbc_product_listings")
}

model ListingImage {
  id         String   @id @default(cuid())
  listingId  String
  urlRemote  String
  pathLocal  String?
  createdAt  DateTime @default(now())
  
  listing    LbcProductListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@map("listing_images")
}

model AiAnalysis {
  id             String   @id @default(cuid())
  listingId      String   @unique
  estMinCents    Int
  estMaxCents    Int
  marginCents    Int      @default(0)
  description    String   @db.Text
  confidence     Float?
  provider       String   @default("openai")
  bestMatchSource String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  listing        LbcProductListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([marginCents])
  @@index([bestMatchSource])
  @@map("ai_analyses")
}

model Notification {
  id        String   @id @default(cuid())
  listingId String
  channel   String   @default("email")
  status    String   @default("pending")
  sentAt    DateTime?
  error     String?  @db.Text
  createdAt DateTime @default(now())
  
  listing   LbcProductListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([status])
  @@map("notifications")
}

model ListingLabel {
  id        String   @id @default(cuid())
  listingId String
  label     String
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  
  listing   LbcProductListing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([label])
  @@map("listing_labels")
}



model Category {
  id        String   @id @default(cuid())
  value     String   @unique
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}
